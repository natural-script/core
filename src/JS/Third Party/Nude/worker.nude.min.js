var skinRegions=[],skinMap=[],canvas={};onmessage=function(a){canvas.width=a.data[1];canvas.height=a.data[2];scanImage(a.data[0])};Array.prototype.remove=function(a){var b=this.slice(a+1);this.length=a;return this.push.apply(this,b)};function scanImage(z){var e=[],B=[],t=canvas.width,k=-1,q=-1;var f=function(x,u){k=x;q=u;var b=B.length,g=-1,o=-1;while(b--){var i=B[b],r=i.length;while(r--){if(i[r]==x){g=b}if(i[r]==u){o=b}}}if(g!=-1&&o!=-1&&g==o){return}if(g==-1&&o==-1){B.push([x,u]);return}if(g!=-1&&o==-1){B[g].push(u);return}if(g==-1&&o!=-1){B[o].push(x);return}if(g!=-1&&o!=-1&&g!=o){B[g]=B[g].concat(B[o]);B.remove(o);return}};var d=z.length,t=canvas.width;for(var v=0,n=1;v<d;v+=4,n++){var p=z[v],w=z[v+1],A=z[v+2],m=(n>t)?((n%t)-1):n,l=(n>t)?(Math.ceil(n/t)-1):1;if(classifySkin(p,w,A)){skinMap.push({id:n,skin:true,region:0,x:m,y:l,checked:false});var c=-1,h=[n-2,(n-t)-2,n-t-1,(n-t)],a=false;for(var s=0;s<4;s++){var j=h[s];if(skinMap[j]&&skinMap[j].skin){if(skinMap[j].region!=c&&c!=-1&&k!=c&&q!=skinMap[j].region){f(c,skinMap[j].region)}c=skinMap[j].region;a=true}}if(!a){skinMap[n-1].region=e.length;e.push([skinMap[n-1]]);continue}else{if(c>-1){if(!e[c]){e[c]=[]}skinMap[n-1].region=c;e[c].push(skinMap[n-1])}}}else{skinMap.push({id:n,skin:false,region:0,x:m,y:l,checked:false})}}merge(e,B);analyseRegions()}function merge(c,f){var d=f.length,h=[];while(d--){var e=f[d],g=e.length;if(!h[d]){h[d]=[]}while(g--){var b=e[g];h[d]=h[d].concat(c[b]);c[b]=[]}}var a=c.length;while(a--){if(c[a].length>0){h.push(c[a])}}clearRegions(h)}function clearRegions(a){var c=a.length;for(var b=0;b<c;b++){if(a[b].length>30){skinRegions.push(a[b])}}}function analyseRegions(){var c=skinRegions.length,a=canvas.width*canvas.height,b=0;if(c<3){postMessage(false);return}(function(){var e=false;while(!e){e=true;for(var f=0;f<c-1;f++){if(skinRegions[f].length<skinRegions[f+1].length){e=false;var d=skinRegions[f];skinRegions[f]=skinRegions[f+1];skinRegions[f+1]=d}}}})();while(c--){b+=skinRegions[c].length}if((b/a)*100<15){postMessage(false);return}if((skinRegions[0].length/b)*100<35&&(skinRegions[1].length/b)*100<30&&(skinRegions[2].length/b)*100<30){postMessage(false);return}if((skinRegions[0].length/b)*100<45){postMessage(false);return}if(skinRegions.length>60){postMessage(false);return}postMessage(true)}function classifySkin(a,j,n){var k=((a>95)&&(j>40&&j<100)&&(n>20)&&((Math.max(a,j,n)-Math.min(a,j,n))>15)&&(Math.abs(a-j)>15)&&(a>j)&&(a>n)),l=toNormalizedRgb(a,j,n),o=l[0],c=l[1],i=l[2],m=(((o/c)>1.185)&&(((a*n)/(Math.pow(a+j+n,2)))>0.107)&&(((a*j)/(Math.pow(a+j+n,2)))>0.112)),f=toHsvTest(a,j,n),e=f[0],p=f[1],d=(e>0&&e<35&&p>0.23&&p<0.68);return(k||m||d)}function toYcc(f,e,c){f/=255,e/=255,c/=255;var h=0.299*f+0.587*e+0.114*c,d=f-h,a=c-h;return[h,d,a]}function toHsv(d,c,a){return[Math.acos((0.5*((d-c)+(d-a)))/(Math.sqrt((Math.pow((d-c),2)+((d-a)*(c-a)))))),1-(3*((Math.min(d,c,a))/(d+c+a))),(1/3)*(d+c+a)]}function toHsvTest(f,e,a){var d=0,j=Math.max(f,e,a),i=Math.min(f,e,a),c=j-i;if(j==f){d=(e-a)/c}else{if(j==e){d=2+((e-f)/c)}else{d=4+((f-e)/c)}}d=d*60;if(d<0){d=d+360}return[d,1-(3*((Math.min(f,e,a))/(f+e+a))),(1/3)*(f+e+a)]}function toNormalizedRgb(e,d,a){var c=e+d+a;return[(e/c),(d/c),(a/c)]};